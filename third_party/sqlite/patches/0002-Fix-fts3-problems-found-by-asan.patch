From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Darwin Huang <huangdarwin@chromium.org>
Date: Fri, 7 Feb 2020 15:34:05 -0800
Subject: [PATCH 2/6] Fix fts3 problems found by asan

Backports https://sqlite.org/src/info/fb7ccf61bed8d862

Bug: 1049131
---
 .../sqlite/patched/ext/fts3/fts3_tokenize_vtab.c    |  2 +-
 third_party/sqlite/patched/ext/fts3/fts3_write.c    |  2 +-
 third_party/sqlite/patched/test/fts3corrupt4.test   | 13 +++++++++++++
 3 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/third_party/sqlite/patched/ext/fts3/fts3_tokenize_vtab.c b/third_party/sqlite/patched/ext/fts3/fts3_tokenize_vtab.c
index 73412ff3b4bb..3be3f1c43b11 100644
--- a/third_party/sqlite/patched/ext/fts3/fts3_tokenize_vtab.c
+++ b/third_party/sqlite/patched/ext/fts3/fts3_tokenize_vtab.c
@@ -350,7 +350,7 @@ static int fts3tokFilterMethod(
     if( pCsr->zInput==0 ){
       rc = SQLITE_NOMEM;
     }else{
-      memcpy(pCsr->zInput, zByte, nByte);
+      if( nByte>0 ) memcpy(pCsr->zInput, zByte, nByte);
       pCsr->zInput[nByte] = 0;
       rc = pTab->pMod->xOpen(pTab->pTok, pCsr->zInput, nByte, &pCsr->pCsr);
       if( rc==SQLITE_OK ){
diff --git a/third_party/sqlite/patched/ext/fts3/fts3_write.c b/third_party/sqlite/patched/ext/fts3/fts3_write.c
index 919e3b6b4d6d..c4b38023518f 100644
--- a/third_party/sqlite/patched/ext/fts3/fts3_write.c
+++ b/third_party/sqlite/patched/ext/fts3/fts3_write.c
@@ -2502,7 +2502,7 @@ static int fts3SegmentIsMaxLevel(Fts3Table *p, i64 iAbsLevel, int *pbMax){
   if( rc!=SQLITE_OK ) return rc;
   sqlite3_bind_int64(pStmt, 1, iAbsLevel+1);
   sqlite3_bind_int64(pStmt, 2,
-      ((iAbsLevel/FTS3_SEGDIR_MAXLEVEL)+1) * FTS3_SEGDIR_MAXLEVEL
+      (((u64)iAbsLevel/FTS3_SEGDIR_MAXLEVEL)+1) * FTS3_SEGDIR_MAXLEVEL
   );
 
   *pbMax = 0;
diff --git a/third_party/sqlite/patched/test/fts3corrupt4.test b/third_party/sqlite/patched/test/fts3corrupt4.test
index bf31d155f6d3..f33654d6aec7 100644
--- a/third_party/sqlite/patched/test/fts3corrupt4.test
+++ b/third_party/sqlite/patched/test/fts3corrupt4.test
@@ -5821,4 +5821,17 @@ do_catchsql_test 36.0 {
   INSERT INTO f(f) VALUES ('merge=53,216');
 } {0 {}}
 
+#-------------------------------------------------------------------------
+#
+reset_db
+do_execsql_test 36.0 {
+  CREATE VIRTUAL TABLE f USING fts3(a,b);
+  CREATE TABLE 'f_stat'(id INTEGER PRIMARY KEY, value BLOB);
+  INSERT INTO f_stat VALUES (1,x'11014101000101c5c5014b010164c5014b010101c50101c5c5010201010101014101000101c5c5014b010101c5014b010101c50101c5c501010100c50101c5c5010101010101e40201010101014101000201010101014101000101010201010101014101000101c5c503b5fefefe3afeffffc5c5c5c50101010101010201010101014101adadadadadadadadadadadad91adadadadadadadad0101c50101c5c501f9ffffffffffffffff0001010102010101010140f5000101c5c5014b010101c50101c5c501010101e6010201010101014101000101c5c5014b010101c50101c5c5010101114b0101c5c50101010a0101020101e60101');
+}
+
+do_catchsql_test 36.1 {
+  INSERT INTO f(f) VALUES ('merge=59,59');
+} {1 {database disk image is malformed}}
+
 finish_test
-- 
2.25.1.481.gfbce0eb801-goog

